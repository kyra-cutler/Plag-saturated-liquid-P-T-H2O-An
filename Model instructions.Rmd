---
title: "Model instructions"
author: "Kyra Cutler"
output:
  html_document:
    toc: true
    toc_float: true
    theme: sandstone
    highlight: haddock

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This is a guide to using the R scripts ('P_T_H2O_An.R', ''T and H2O error propagation.R', 'H2O content range.R') as mentioned in Cutler et al. (?). 

Link to pre-print: 


## To get started

1) Click on the green code button on the Github page and download the zip file. Do not remove or delete any files within this folder.

2) Enter your normalised glass compositional data into the INPUT.xlsx spreadsheet. All oxide (wt.%) columns must be filled or entered with zero. 

3) Open the 'P_T_H2O_An.R' script. Install the packages and load the libraries.

```{r install packages, eval=FALSE}
#--------------------(1) R ENVIRONMENT + DATA INPUT PREP-----------------------#
# Install packages if required (Note: ExtraTrees package is now archived) 
url <- "https://cran.r-project.org/src/contrib/Archive/extraTrees/extraTrees_1.0.5.tar.gz"
pkgFile <- "extraTrees_1.0.5.tar.gz"
download.file(url = url, destfile = pkgFile)
install.packages(pkgs=pkgFile, type="source", repos=NULL)
install.packages("writexl")
install.packages("readxl")
install.packages("gdata")
install.packages("dplyr")
install.packages("rstudioapi")
install.packages("ggplot2")
install.packages("ggpubr")

# Run required libraries for this script 
library(extraTrees)
library(writexl) 
library(gdata)
library(dplyr)
library(readxl)
library(ggplot2)
library(rstudioapi)
library(ggpubr)

```

4) Load your input data. You do not need to set a specific file pathway as the script will find the location of downloaded folder from Github page (https://github.com/kyra-cutler/Plag-saturated-melt-P-T-H2O-An). 

```{r load input data}
library(readxl)

# Set file pathway and load input data
setwd(paste(dirname(rstudioapi::getActiveDocumentContext()$path)))
inputdata <- read_excel("INPUT.xlsx")
INPUT <- as.data.frame (inputdata)
# Checks first rows of data 
head(INPUT)

```

5) You can check whether your glass compositions are within the calibration ranges of the models. To compare barometer calibration, you need to change the this code [ ,sheet = Input for T, H2O & An' to sheet = "Input for P") ].

```{r load calibration range}
library(readxl)
library(ggplot2)
library(ggpubr)

# Check if liquid data are within calibration range 
# Change sheet name to "Input for P" for pressure calibration comparison
calibration_data <- read_excel("Supplementary Table 1_calibration dataset_P-T-H2O-An.xlsx", sheet = "Input for T, H2O & An")
Alkalis <- INPUT$Na2O_liq + INPUT$K2O_liq 
INPUT_calibrationcheck <- cbind(INPUT,Alkalis,Data="new_data")
calibration_data <- calibration_data[ -c(11:24)]
INPUT_calibrationcheck <- INPUT_calibrationcheck[ -c(3,12,13)]
calibration_data <- rbind(calibration_data, INPUT_calibrationcheck)

# TAS diagram comparison 
ggplot(calibration_data, aes(x=SiO2_liq, y=Alkalis,colour=Data,shape=Data)) +
  geom_point(size=5, stroke=0.5)+
  scale_colour_manual(values=c("#DEDEDE","#581E4F"))+
  theme_pubr(border=TRUE)+
  xlab("SiO2 (wt.%)")+
  xlim(35, 80)+
  ylim(0,15)+
  ylab("Na2O + K2O (wt.%)")+
  theme(legend.position="bottom")
```

## Plagioclase saturation check

If needed, you can also check whether your matrix glass compositions represent plagioclase-saturated melts by using the plagioclase-saturated melt classifier. Once you generate the filtered output file of plagioclase-saturated compositions, change the name of the input file from [ inputdata <- read_excel("INPUT.xlsx") ] to [ inputdata <- read_excel("OUTPUT_plagsat.xlsx") ] and reload the file.


```{r plagioclase saturation, eval =FALSE}
#-------(2) PLAGIOCLASE SATURATION CHECK (if needed, otherwise skip step)------#
# Load model
load("plag_saturated?.Rdata")

# Isolating the model predictors
dropcolumns <- c("Ref","Sample","H2O","T","Type")
INPUT = INPUT[,!(names(INPUT) %in% dropcolumns)]
INPUT

# Run the model
plag_sat_check <- predict(plagsat_final, newdata = INPUT)
plag_sat_check<-as.data.frame(plag_sat_check)

# Creating output file 
plag_saturated <-cbind(inputdata,plag_sat_check)
filtered_plag_saturated <- plag_saturated%>% dplyr::filter(grepl('Yes', plag_sat_check))
write_xlsx(filtered_plag_saturated, 'OUTPUT_plagsat.xlsx') #replace input file name in step 1

```

## Obtaining An-T-H2O-P estimates 

Section '(3) AN CONTENT' should be run first to obtain predictions of equilibrium plagioclase compositions that can be compared to your plagioclase EPMA analyses.

Section (4), (5) and (6) in the 'P-T-H2O-An.R' script allow you to obtain predictions for temperature, water content and pressure. If you want to use the T or H2O-dependent models, check the comments to ensure you have added all the input parameters for the model you want to run. 

An example of section (4) THERMOMETRY is shown below. 

```{r thermometry example, eval =FALSE}
#------------------------------(4) THERMOMETRY---------------------------------#
# Load models
load("liquid_noH2O_thermometer.Rdata") # H2O-independent thermometer
load("liquid_thermometer.Rdata") # H2O-dependent thermometer 

# If using H2O-dependent thermometer with an independent H2O estimate, add in H2O column to input dataframe
dropcolumns <- c("Ref","Sample","T","Type","plag_sat_check")
INPUTwH2O = inputdata[,!(names(inputdata) %in% dropcolumns)]
INPUTwH2O

# Run models
predT_liq <- predict(liquidT_noH2O_final, newdata = INPUT,allValues=TRUE)
predTwH2O_liq <- predict(liquidT_final, newdata = INPUTwH2O,allValues=TRUE)

# Calculating median and SD for temperature values (H2O-independent thermometer)
Tliq_median <- round(apply(predT_liq, 1, median), digits = 0)
Tliq_sd <-round(apply(predT_liq,1,sd),0)
# Check values 
Tliq_median
Tliq_sd

# Calculating median and SD for temperature values (H2O-dependent thermometer)
TwH2Oliq_median <- round(apply(predTwH2O_liq, 1, median), digits = 0)
TwH2Oliq_sd <-round(apply(predTwH2O_liq,1,sd),1)
# Check values 
TwH2Oliq_median
TwH2Oliq_sd

```

## Filtering & saving estimates 

All estimates will be saved as an Excel file (.xlsx). The file will contain the original input data + the calculated parameters (P-T-H2O-An). You can filter the P-T-H2O-An estimates by removing the highest standard deviation values (i.e., currently set up to remove values above the 75th quartile for the P-T-An models or above the 50th quartile for the H2O models; feel free to change).

```{r filtering and saving, eval =FALSE}

#----------------------(7) FILTERING & SAVING ESTIMATES------------------------#
# Save results (take out # to include models or add in # to remove unused models)
OUTPUT <- cbind(inputdata, An_median,An_sd,
                Tliq_median,Tliq_sd,
                #TwH2Oliq_median,TwH2Oliq_sd, 
                H2Oliq_median,H2Oliq_sd,
                H2OnoTliq_median, H2OnoTliq_sd,
                Pliq_median,Pliq_sd,
                Pnwliq_median,Pnwliq_sd)
write_xlsx(OUTPUT,"eruption_estimates.xlsx")

# Set up filters (currently removes values above 75th quantile for P-T-An and values above 50th quantile for H2O)
An_quantile <- quantile(An_sd, c(0.75)) 
T_quantile <- quantile(Tliq_sd, c(0.75)) 
#TwH2O_quantile <- quantile(TwH2Oliq_sd, c(0.75)) 
H2O_quantile <- quantile(H2Oliq_sd, c(0.5)) 
H2OnT_quantile <- quantile(H2OnoTliq_sd, c(0.5)) 
P_quantile <- quantile(Pliq_sd, c(0.75)) 
Pnw_quantile <- quantile(Pnwliq_sd, c(0.75)) 

# Filter all estimates (take out # to include models or add in # to remove unused models)
filtered_OUTPUT <- OUTPUT %>% mutate(An_median = replace(An_median, An_sd >= An_quantile, NA),
                                     An_sd = replace(An_sd, An_sd >= An_quantile, NA),
                                     Tliq_median = replace(Tliq_median, Tliq_sd >= T_quantile,NA),
                                     Tliq_sd = replace(Tliq_sd, Tliq_sd >= T_quantile,NA),
                                     #TwH2Oliq_median = replace(TwH2Oliq_median, TwH2Oliq_sd >= TwH2O_quantile,NA),
                                     #TwH2Oliq_sd = replace(TwH2Oliq_sd, TwH2Oliq_sd >= TwH2O_quantile,NA),
                                     H2Oliq_median = replace(H2Oliq_median, H2Oliq_sd >= H2O_quantile,NA),
                                     H2Oliq_sd = replace(H2Oliq_sd, H2Oliq_sd >= H2O_quantile,NA),
                                     H2OnoTliq_median = replace(H2OnoTliq_median, H2OnoTliq_sd >= H2OnT_quantile,NA),
                                     H2OnoTliq_sd = replace(H2OnoTliq_sd, H2OnoTliq_sd >= H2OnT_quantile,NA),
                                     Pliq_median = replace(Pliq_median, Pliq_sd >= P_quantile, NA),
                                     Pliq_sd = replace(Pliq_sd, Pliq_sd >= P_quantile, NA),
                                     Pnwliq_median = replace(Pnwliq_median, Pnwliq_sd >= Pnw_quantile, NA),
                                     Pnwliq_sd = replace(Pnwliq_sd, Pnwliq_sd >= Pnw_quantile, NA))

# Save filtered file 
write_xlsx(filtered_OUTPUT,"eruption_estimates_filtered.xlsx")
#write_xlsx(plag_saturated,"glass_plagsaturated.xlsx")
```

## Error propagation of T or H2O 

If you want to propagate the temperature and water content errors when using the T-dependent hygrometer and H2O-dependent barometer, open up the 'T and H2O error propagation.R' script. Do not clear your global environment as you can combine the output from the 'P_T_H2O_An.R' script with the output from the 'T and H2O error propagation.R' script. 


## Testing a range of water contents 

If you want to test using a range of water contents with the H2O-dependent thermometer or barometer, then open up the 'H2O content range.R' script. Again, do not clear your global environment as you can combine the output from the 'P_T_H2O_An.R' script with the output from the 'H2O content range.R' script. 






